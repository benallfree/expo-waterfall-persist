{"version":3,"file":"expo-waterfall-persist.dev.js","sources":["../src/index.js"],"sourcesContent":["import { FileSystem } from 'expo'\nimport _ from 'lodash'\nimport PropTypes from 'prop-types'\n\nconst Log = {\n  debug() {\n    console.log.apply(null, arguments)\n  },\n  error() {\n    console.error.apply(null, arguments)\n  }\n}\n\nconst propTypes = {\n  fileUri: PropTypes.string,\n  debounce: PropTypes.object,\n  onLoaded: PropTypes.func,\n  onSaved: PropTypes.func,\n  onSaveError: PropTypes.func,\n  onLoadError: PropTypes.func,\n  onVersionMismatch: PropTypes.func,\n  onPersistedStateNotFound: PropTypes.func,\n  onReady: PropTypes.func\n}\n\nconst defaultProps = {\n  fileUri: `${FileSystem.documentDirectory}/state.json`,\n  debounce: {\n    wait: 250,\n    maxWait: 1000\n  },\n  onLoaded({ state, fileUri }) {\n    Log.debug(`State loaded from ${fileUri}`, state)\n  },\n  onSaved({ state, fileUri }) {\n    Log.debug(`State saved to ${fileUri}`, state)\n  },\n  onSaveError({ error, fileUri }) {\n    Log.debug(`Failed to save ${fileUri}`)\n    Log.error(error)\n    throw error\n  },\n  onLoadError({ error, fileUri }) {\n    Log.debug(`Failed to load ${fileUri}`)\n    Log.error(error)\n    throw error\n  },\n  onVersionMismatch({ oldState, newVersion }) {\n    Log.debug(\n      `Version mismatch (${oldState.version} vs ${newVersion}). State reset.`,\n      oldState\n    )\n  },\n  onPersistedStateNotFound({ fileUri }) {\n    Log.debug(`No saved state found on ${fileUri}, using defaults.`)\n  },\n  onReady() {\n    Log.debug('Provider is ready.')\n  }\n}\n\nfunction persist({ setState, Provider, subscribe }) {\n  Provider.propTypes = _.merge({}, propTypes, Provider.propTypes)\n  Provider.defaultProps = _.merge({}, defaultProps, Provider.defaultProps)\n  let oldComponentWillMount = Provider.prototype.componentWillMount\n  Provider.prototype.componentWillMount = function() {\n    if (oldComponentWillMount) oldComponentWillMount.call(this, ...arguments)\n    this.setState({ __isStateReady: false })\n  }\n  let oldRender = Provider.prototype.render\n  Provider.prototype.render = function() {\n    if (!this.state.__isStateReady) return null\n    return oldRender.call(this, ...arguments)\n  }\n\n  return function(config, providerInstance) {\n    let tryCall = function(func, args) {\n      if (!func) return\n      return func(args)\n    }\n\n    new Promise(resolve => {\n      FileSystem.readAsStringAsync(providerInstance.props.fileUri)\n        .then(s => {\n          let state = JSON.parse(s)\n          if (!state || state.version != config.initialState.version) {\n            tryCall(providerInstance.props.onVersionMismatch, {\n              oldState: state,\n              newVersion: config.initialState.version\n            })\n          } else {\n            tryCall(providerInstance.props.onLoaded, {\n              state,\n              fileUri: providerInstance.props.fileUri\n            })\n            resolve(state)\n          }\n          resolve(config.initialState)\n        })\n        .catch(error => {\n          if (error.code === 'E_FILE_NOT_READ') {\n            tryCall(providerInstance.props.onPersistedStateNotFound, {\n              fileUri: providerInstance.props.fileUri\n            })\n          } else {\n            tryCall(providerInstance.props.onLoadError, {\n              error,\n              fileUri: providerInstance.props.fileUri\n            })\n          }\n          resolve(config.initialState)\n        })\n    }).then(stateMirror => {\n      setState('__persist__', stateMirror)\n      let save = _.debounce(\n        () => {\n          FileSystem.writeAsStringAsync(\n            providerInstance.props.fileUri,\n            JSON.stringify(stateMirror)\n          )\n            .then(() => {\n              tryCall(providerInstance.props.onSaved, {\n                state: stateMirror,\n                fileUri: providerInstance.props.fileUri\n              })\n            })\n            .catch(error => {\n              tryCall(providerInstance.props.onSaveError, {\n                error,\n                fileUri: providerInstance.props.fileUri\n              })\n            })\n        },\n        providerInstance.props.debounce.wait,\n        { maxWait: providerInstance.props.debounce.maxWait }\n      )\n      subscribe(function(actionName, stateFragmentResult) {\n        _.merge(stateMirror, stateFragmentResult)\n        save()\n      })\n      providerInstance.setState({ __isStateReady: true })\n      tryCall(providerInstance.props.onReady)\n    })\n    return function(action, ...args) {\n      // noop\n    }\n  }\n}\n\nexport { persist }\n"],"names":["Log","log","apply","arguments","error","propTypes","PropTypes","string","object","func","defaultProps","FileSystem","documentDirectory","state","fileUri","debug","oldState","newVersion","version","persist","setState","Provider","subscribe","_","merge","oldComponentWillMount","prototype","componentWillMount","call","this","oldRender","render","__isStateReady","config","providerInstance","tryCall","args","Promise","readAsStringAsync","props","then","JSON","parse","s","initialState","onLoaded","onVersionMismatch","catch","code","onPersistedStateNotFound","onLoadError","stateMirror","save","debounce","writeAsStringAsync","stringify","onSaved","onSaveError","wait","maxWait","actionName","stateFragmentResult","onReady","action"],"mappings":"uQAIMA,8BAEMC,IAAIC,MAAM,KAAMC,qCAGhBC,MAAMF,MAAM,KAAMC,aAIxBE,mBACKC,UAAUC,gBACTD,UAAUE,gBACVF,UAAUG,aACXH,UAAUG,iBACNH,UAAUG,iBACVH,UAAUG,uBACJH,UAAUG,8BACHH,UAAUG,aAC3BH,UAAUG,MAGfC,gCACQC,gBAAWC,gDAEf,YACG,8BAEAC,IAAAA,MAAOC,IAAAA,YACZC,kCAA2BD,GAAWD,4BAElCA,IAAAA,MAAOC,IAAAA,YACXC,+BAAwBD,GAAWD,gCAE3BT,IAAAA,MAAOU,IAAAA,kBACfC,+BAAwBD,QACxBV,MAAMA,GACJA,+BAEMA,IAAAA,MAAOU,IAAAA,kBACfC,+BAAwBD,QACxBV,MAAMA,GACJA,qCAEYY,IAAAA,SAAUC,IAAAA,eACxBF,kCACmBC,EAASE,uBAAcD,qBAC5CD,6CAGuBF,IAAAA,YACrBC,wCAAiCD,gDAGjCC,MAAM,wBAId,SAASI,eAAUC,IAAAA,SAAUC,IAAAA,SAAUC,IAAAA,YAC5BjB,UAAYkB,EAAEC,SAAUnB,UAAWgB,EAAShB,aAC5CK,aAAea,EAAEC,SAAUd,aAAcW,EAASX,kBACvDe,EAAwBJ,EAASK,UAAUC,qBACtCD,UAAUC,mBAAqB,WAClCF,GAAuBA,EAAsBG,cAAKC,wCAAS1B,kBAC1DiB,0BAA2B,SAE9BU,EAAYT,EAASK,UAAUK,gBAC1BL,UAAUK,OAAS,kBACrBF,KAAKhB,MAAMmB,eACTF,EAAUF,cAAKC,wCAAS1B,aADQ,MAIlC,SAAS8B,EAAQC,OAClBC,EAAU,SAAS1B,EAAM2B,MACtB3B,SACEA,EAAK2B,eAGVC,QAAQ,4BACCC,kBAAkBJ,EAAiBK,MAAMzB,SACjD0B,KAAK,gBACA3B,EAAQ4B,KAAKC,MAAMC,GAClB9B,GAASA,EAAMK,SAAWe,EAAOW,aAAa1B,WAMzCgB,EAAiBK,MAAMM,0BAEpBX,EAAiBK,MAAMzB,YAE1BD,MATAqB,EAAiBK,MAAMO,4BACnBjC,aACEoB,EAAOW,aAAa1B,YAS5Be,EAAOW,gBAEhBG,MAAM,YACc,oBAAf3C,EAAM4C,OACAd,EAAiBK,MAAMU,kCACpBf,EAAiBK,MAAMzB,YAG1BoB,EAAiBK,MAAMW,6BAEpBhB,EAAiBK,MAAMzB,YAG5BmB,EAAOW,kBAElBJ,KAAK,cACG,cAAeW,OACpBC,EAAO7B,EAAE8B,SACX,2BACaC,mBACTpB,EAAiBK,MAAMzB,QACvB2B,KAAKc,UAAUJ,IAEdX,KAAK,aACIN,EAAiBK,MAAMiB,eACtBL,UACEjB,EAAiBK,MAAMzB,YAGnCiC,MAAM,cACGb,EAAiBK,MAAMkB,6BAEpBvB,EAAiBK,MAAMzB,aAIxCoB,EAAiBK,MAAMc,SAASK,cACrBxB,EAAiBK,MAAMc,SAASM,YAEnC,SAASC,EAAYC,KAC3BrC,MAAM2B,EAAaU,WAGNzC,0BAA2B,MACpCc,EAAiBK,MAAMuB,WAE1B,SAASC"}