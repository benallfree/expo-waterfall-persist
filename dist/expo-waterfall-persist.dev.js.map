{"version":3,"file":"expo-waterfall-persist.dev.js","sources":["../src/index.js"],"sourcesContent":["import { FileSystem } from 'expo'\nimport { default as baseCreateStore } from 'react-waterfall'\nimport _ from 'lodash'\n\nfunction createStoreAsync(config, options = {}) {\n  const Log = {\n    debug() {\n      console.log.apply(null, arguments)\n    },\n    error() {\n      console.error.apply(null, arguments)\n    }\n  }\n\n  const defaults = {\n    fileUri: `${FileSystem.documentDirectory}/state.json`,\n    debounce: {\n      wait: 250,\n      maxWait: 1000\n    },\n    onLoaded({ state, fileUri }) {\n      Log.debug(`State loaded from ${fileUri}`, state)\n    },\n    onSaved(state, fileUri) {\n      Log.debug(`State saved to ${fileUri}`, state)\n    },\n    onSaveError({ error, fileUri }) {\n      Log.debug(`Failed to save ${fileUri}`)\n      Log.error(error)\n      throw error\n    },\n    onLoadError({ error, fileUri }) {\n      Log.debug(`Failed to load ${fileUri}`)\n      Log.error(error)\n      throw error\n    },\n    onVersionMismatch({ oldState, newVersion }) {\n      Log.debug(\n        `Version mismatch (${oldState.version} vs ${newVersion}). State reset.`,\n        oldState\n      )\n    },\n    onPersistedStateNotFound({ fileUri }) {\n      Log.debug(`No saved state found on ${fileUri}, using defaults.`)\n    }\n  }\n  const opts = _.merge({}, defaults, options)\n\n  return new Promise((resolve, reject) => {\n    const {\n      fileUri,\n      onLoadError,\n      onSaveError,\n      onSaved,\n      onVersionMismatch,\n      onLoaded,\n      onPersistedStateNotFound\n    } = opts\n    new Promise((resolve, reject) => {\n      FileSystem.readAsStringAsync(fileUri)\n        .then(s => {\n          let state = JSON.parse(s)\n          if (!state || state.version != config.initialState.version) {\n            onVersionMismatch({\n              oldState: state,\n              newVersion: config.initialState.version\n            })\n          } else {\n            onLoaded({ state, fileUri })\n            config.initialState = { ...state }\n          }\n\n          resolve(config)\n        })\n        .catch(error => {\n          if (error.code === 'E_FILE_NOT_READ') {\n            onPersistedStateNotFound({ fileUri })\n          } else {\n            onLoadError({ error, fileUri })\n          }\n          resolve(config)\n        })\n    }).then(config => {\n      let stateMirror = _.merge({}, config.initialState)\n      const Waterfall = baseCreateStore(config)\n\n      let save = _.debounce(\n        () => {\n          FileSystem.writeAsStringAsync(fileUri, JSON.stringify(stateMirror))\n            .then(() => {\n              onSaved({ state: stateMirror, fileUri })\n            })\n            .catch(error => {\n              onSaveError({ error, fileUri })\n            })\n        },\n        opts.debounce.wait,\n        { maxWait: opts.debounce.maxWait }\n      )\n      Waterfall.subscribe(function(actionName, stateFragmentResult) {\n        _.merge(stateMirror, stateFragmentResult)\n        save()\n      })\n      resolve(Waterfall)\n    })\n  })\n}\n\nexport { createStoreAsync }\n"],"names":["createStoreAsync","config","options","Log","log","apply","arguments","error","defaults","FileSystem","documentDirectory","state","fileUri","oldState","newVersion","version","opts","_","merge","Promise","resolve","reject","onLoadError","onSaveError","onSaved","onVersionMismatch","onLoaded","onPersistedStateNotFound","readAsStringAsync","then","JSON","parse","s","initialState","catch","code","stateMirror","Waterfall","baseCreateStore","save","debounce","writeAsStringAsync","stringify","wait","maxWait","subscribe","actionName","stateFragmentResult"],"mappings":"svBAIA,SAASA,iBAAiBC,OAAQC,4DAC1BC,qBAEMC,IAAIC,MAAM,KAAMC,YAFtBH,qBAKMI,MAAMF,MAAM,KAAMC,YAIxBE,qBACQC,gBAAWC,gDAEf,YACG,8BAEAC,IAAAA,MAAOC,IAAAA,sCACeA,GAAWD,qBAEpCA,EAAOC,8BACeA,GAAWD,gCAE3BJ,IAAAA,MAAOK,IAAAA,yCACSA,MAClBL,GACJA,+BAEMA,IAAAA,MAAOK,IAAAA,yCACSA,MAClBL,GACJA,qCAEYM,IAAAA,SAAUC,IAAAA,yCAELD,EAASE,uBAAcD,qBAC5CD,6CAGuBD,IAAAA,4CACYA,0BAGnCI,EAAOC,EAAEC,SAAUV,EAAUN,UAE5B,IAAIiB,QAAQ,SAACC,EAASC,OAEzBT,EAOEI,EAPFJ,QACAU,EAMEN,EANFM,YACAC,EAKEP,EALFO,YACAC,EAIER,EAJFQ,QACAC,EAGET,EAHFS,kBACAC,EAEEV,EAFFU,SACAC,EACEX,EADFW,6BAEER,QAAQ,SAACC,EAASC,mBACTO,kBAAkBhB,GAC1BiB,KAAK,gBACAlB,EAAQmB,KAAKC,MAAMC,GAClBrB,GAASA,EAAMI,SAAWd,EAAOgC,aAAalB,kCAO1CkB,8BAAoBtB,gBALfA,aACEV,EAAOgC,aAAalB,YAO5Bd,KAETiC,MAAM,YACc,oBAAf3B,EAAM4B,6CAKFlC,OAEX4B,KAAK,gBACFO,EAAcnB,EAAEC,SAAUjB,EAAOgC,cAC/BI,EAAYC,gBAAgBrC,GAE9BsC,EAAOtB,EAAEuB,SACX,2BACaC,mBAAmB7B,EAASkB,KAAKY,UAAUN,IACnDP,KAAK,oBACaO,gBAElBF,MAAM,sCAIXlB,EAAKwB,SAASG,cACH3B,EAAKwB,SAASI,YAEjBC,UAAU,SAASC,EAAYC,KACrC7B,MAAMkB,EAAaW,WAGfV"}